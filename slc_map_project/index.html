<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SLC Strike Businesses - Jan 30 General Strike</title>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }

  #legend {
    position: absolute;
    bottom: 30px;
    left: 10px;
    background: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    font-size: 13px;
    z-index: 1;
  }
  #legend h3 { margin-bottom: 8px; font-size: 14px; }
  .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
  .legend-dot {
    width: 12px; height: 12px; border-radius: 50%;
    margin-right: 8px; flex-shrink: 0;
    border: 1px solid rgba(0,0,0,0.2);
  }

  .mapboxgl-popup-content {
    padding: 16px;
    max-width: 300px;
    font-size: 14px;
    line-height: 1.4;
  }
  .popup-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
  .popup-subtype { color: #666; font-style: italic; margin-bottom: 8px; }
  .popup-address { margin-bottom: 8px; }
  .popup-section { margin-bottom: 6px; }
  .popup-section strong { display: block; color: #333; }
  .popup-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    color: white;
    margin-bottom: 8px;
  }

  .marker {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.35);
    cursor: pointer;
    transition: transform 0.15s;
  }
  .marker:hover { transform: scale(1.2); }

  #token-prompt {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex; align-items: center; justify-content: center;
    z-index: 10;
  }
  #token-prompt div {
    background: white; padding: 32px; border-radius: 12px;
    max-width: 460px; text-align: center;
  }
  #token-prompt h2 { margin-bottom: 12px; }
  #token-prompt p { margin-bottom: 16px; color: #555; font-size: 14px; }
  #token-prompt input {
    width: 100%; padding: 10px; font-size: 14px;
    border: 1px solid #ccc; border-radius: 6px; margin-bottom: 12px;
  }
  #token-prompt button {
    padding: 10px 24px; font-size: 14px; background: #3b82f6;
    color: white; border: none; border-radius: 6px; cursor: pointer;
  }
  #token-prompt button:hover { background: #2563eb; }
</style>
</head>
<body>

<div id="token-prompt">
  <div>
    <h2>Mapbox Access Token</h2>
    <p>Enter your Mapbox public access token to load the map.<br>
    Get one free at <a href="https://mapbox.com" target="_blank">mapbox.com</a></p>
    <input type="text" id="token-input" placeholder="pk.eyJ1Ij...">
    <br>
    <button onclick="initMap()">Load Map</button>
  </div>
</div>

<div id="map"></div>

<div id="legend" style="display:none;">
  <h3>Strike Actions</h3>
  <div class="legend-item"><div class="legend-dot" style="background:#dc2626"></div> Closed All Day</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ea580c"></div> Closing Early</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ca8a04"></div> Partial Closure</div>
  <div class="legend-item"><div class="legend-dot" style="background:#16a34a"></div> Open as Community Space</div>
  <div class="legend-item"><div class="legend-dot" style="background:#2563eb"></div> Open with Donations</div>
  <div class="legend-item"><div class="legend-dot" style="background:#9333ea"></div> Donating</div>
</div>

<script>
const ACTION_COLORS = {
  closed_all_day:          '#dc2626',
  closing_early:           '#ea580c',
  partial_closure:         '#ca8a04',
  open_as_community_space: '#16a34a',
  open_with_donations:     '#2563eb',
  donating:                '#9333ea'
};

const ACTION_LABELS = {
  closed_all_day:          'Closed All Day',
  closing_early:           'Closing Early',
  partial_closure:         'Partial Closure',
  open_as_community_space: 'Open as Community Space',
  open_with_donations:     'Open with Donations',
  donating:                'Donating'
};

function formatHours(h) {
  if (!h) return '';
  const parts = [];
  if (h.open) parts.push('Opens: ' + h.open);
  if (h.close) parts.push('Closes: ' + h.close);
  if (h.reopen) parts.push('Reopens: ' + h.reopen);
  if (h.notes) parts.push(h.notes);
  return parts.join('<br>');
}

function buildPopup(b) {
  const color = ACTION_COLORS[b.strike_action] || '#888';
  const label = ACTION_LABELS[b.strike_action] || b.strike_action;
  let html = `<div class="popup-name">${b.name}</div>`;
  if (b.subtype) html += `<div class="popup-subtype">${b.subtype}</div>`;
  html += `<div class="popup-badge" style="background:${color}">${label}</div>`;
  if (b.address) html += `<div class="popup-address">${b.address}</div>`;
  const hours = formatHours(b.strike_day_hours);
  if (hours) html += `<div class="popup-section"><strong>Strike Day:</strong>${hours}</div>`;
  if (b.donations && b.donations.donating && b.donations.details) {
    html += `<div class="popup-section"><strong>Donations:</strong>${b.donations.details}</div>`;
  }
  if (b.instagram_handle) {
    html += `<div class="popup-section" style="margin-top:8px;font-size:12px;">@${b.instagram_handle}</div>`;
  }
  return html;
}

function initMap() {
  const token = document.getElementById('token-input').value.trim();
  if (!token) return;

  document.getElementById('token-prompt').style.display = 'none';
  document.getElementById('legend').style.display = 'block';

  mapboxgl.accessToken = token;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [-111.89, 40.76],
    zoom: 12
  });

  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  fetch('slc_strike_businesses.json')
    .then(r => r.json())
    .then(data => {
      data.businesses.forEach(b => {
        if (b.lat == null || b.lng == null) return;

        const color = ACTION_COLORS[b.strike_action] || '#888';
        const el = document.createElement('div');
        el.className = 'marker';
        el.style.background = color;

        new mapboxgl.Marker({ element: el })
          .setLngLat([b.lng, b.lat])
          .setPopup(new mapboxgl.Popup({ offset: 18, maxWidth: '320px' }).setHTML(buildPopup(b)))
          .addTo(map);
      });
    });
}
</script>
</body>
</html>
